<div id="sidebar">
    <strong><small>
        POST STATUS:
        <span id="poststatus">
            {% if post.draft %}
            Draft
            {% else %}
                {% if post.slug %}
                Published
                {% else %}
                Draft
                {% endif %}
            {% endif %}
        </span>
    </small></strong>
    <a
        href="#"
        id="closeSidebar"
        _="on click remove .visible from #sidebar"
    >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="left-arrow" class="small icon"><g data-name="Layer 2"><g data-name="arrowhead-left" fill="#134563"><path d="M11.64 5.23a1 1 0 0 0-1.41.13l-5 6a1 1 0 0 0 0 1.27l4.83 6a1 1 0 0 0 .78.37 1 1 0 0 0 .78-1.63L7.29 12l4.48-5.37a1 1 0 0 0-.13-1.4z"></path><path d="m14.29 12 4.48-5.37a1 1 0 0 0-1.54-1.28l-5 6a1 1 0 0 0 0 1.27l4.83 6a1 1 0 0 0 .78.37 1 1 0 0 0 .78-1.63z"></path></g></g></svg>
    </a>
    <form class="frmFrontmatter">
        <input type="text" name="title" id="txtTitle" placeholder="Title" value="{{ post.title }}"
            _=" on input
                if '{{ post.slug }}' is empty --- i.e. if the post doesn't exist yet
                    set value of #txtSlug to slugify(my value)
                    put slugify(my value) + '.jpg' into #slugimage
                end
            "
        >
        <input type="text" name="slug" id="txtSlug" placeholder="Slug" value="{{ post.slug }}">
        <input type="text" name="date" id="txtDate" placeholder="Date" value="{{ post.date }}">
        <input type="text" name="tags" id="txtTags" placeholder="Tags" value="{{ post.tags }}">
        <input type="text" name="imageClass" id="txtImageClass" placeholder="CSS class for main image" value="{{ post.imageClass }}">
        <div>
            <input type="checkbox" id="image" name="image" />
            <label for="image">
                <small>
                    Use <a href="{{ imagekit_bucket }}/{{ post.slug }}.jpg" target="_blank" id="slugimage">{{ post.slug }}.jpg</a> as main image
                </small>
            </label>
        </div>

        <a href="{% url 'cmshtmx_index' %}" id="homeSidebar" title="Home">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" id="home">
                <path fill="none" stroke="#134563" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.65721519,18.7714023 L6.65721519,15.70467 C6.65719744,14.9246392 7.29311743,14.2908272 8.08101266,14.2855921 L10.9670886,14.2855921 C11.7587434,14.2855921 12.4005063,14.9209349 12.4005063,15.70467 L12.4005063,15.70467 L12.4005063,18.7809263 C12.4003226,19.4432001 12.9342557,19.984478 13.603038,20 L15.5270886,20 C17.4451246,20 19,18.4606794 19,16.5618312 L19,16.5618312 L19,7.8378351 C18.9897577,7.09082692 18.6354747,6.38934919 18.0379747,5.93303245 L11.4577215,0.685301154 C10.3049347,-0.228433718 8.66620456,-0.228433718 7.51341772,0.685301154 L0.962025316,5.94255646 C0.362258604,6.39702249 0.00738668938,7.09966612 0,7.84735911 L0,16.5618312 C0,18.4606794 1.55487539,20 3.47291139,20 L5.39696203,20 C6.08235439,20 6.63797468,19.4499381 6.63797468,18.7714023 L6.63797468,18.7714023" transform="translate(2.5 2)"></path></svg>
        </a>

        <div class="buttonrow">
            <button
                class="publish savedraft"
                id="savedraft"
                hx-post="{% url 'cmshtmx_savedraft' %}"
                hx-swap="beforeend"
                hx-indicator="#saveLoading"
                hx-vals="js:{
                    content: document.getElementById('editBox').value,
                    draft: true,
                    slug: '{{ post.slug }}'
                }"
                hx-select=".status"
                hx-on::after-request="showAfterRequest('saveAction', 1000)"
                _="on click hide #saveAction"
                >
                <span id="saveAction">Save draft</span>
                <span class="spinner" id="saveLoading"></span>
            </button>

            <button
                class="publish unpublish"
                id="unpublish"
                hx-post="{% url 'cmshtmx_unpublish' %}"
                hx-swap="beforeend"
                hx-indicator="#unpublishLoading"
                hx-vals="js:{
                    content: document.getElementById('editBox').value,
                    draft: true,
                    slug: '{{ post.slug }}'
                }"
                hx-select=".status"
                hx-on::after-request="showAfterRequest('unpublishAction', 1000)"
                _="on click hide #unpublishAction"
                >
                <span id="unpublishAction">Unpublish</span>
                <span class="spinner" id="unpublishLoading"></span>
            </button>

            <button
                class="publish"
                id="publish"
                hx-post="{% url 'cmshtmx_publish' %}"
                hx-swap="beforeend"
                hx-indicator="#publishLoading"
                hx-vals="js:{
                    content: document.getElementById('editBox').value,
                    slug: '{{ post.slug }}'
                }"
                hx-select=".status"
                hx-on::after-request="showAfterRequest('publishAction', 1000)"
                _="on click hide #publishAction"
                >
                <span id="publishAction">Publish</span>
                <span class="spinner" id="publishLoading"></span>
            </button>
        </div>

    </form>
</div>

<script type="text/hyperscript">
    js
        function slugify(str) {
            return String(str)
            .normalize('NFKD')
            .replace(/[\u0300-\u036f]/g, '')
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9 -]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
        }
        return { slugify };
    end

    on load from body
        set draft to '{{ post.draft }}'
        set slug to '{{ post.slug }}'
        set image to '{{ post.image }}'
        if draft is 'False' or draft is empty or draft is 'false'
            if slug is not empty
                hide #savedraft
                show #unpublish
            else
                hide #unpublish
            end
        else
            show #savedraft
            hide #unpublish
        end

        if image is 'True' or image is 'true' or image is true
            add [@checked] to #image
        else
            remove [@checked] from #image
        end
    end

    def showAfterRequest(elementId, waitms)
        --- NOTE: The following can also be done like this:
        --- wait waitms then hide .status then show #{elementId}
        wait waitms
        hide .status
        show #{elementId}
        if elementId is "unpublishAction"
            show #savedraft
            hide #unpublish
            set #poststatus.innerHTML to 'Draft'
        else
            if elementId is "publishAction"
                hide #savedraft
                show #unpublish
                set #poststatus.innerHTML to 'Published'
            end
        end
    end
</script>

<style>
    #sidebar {
        position: fixed;
        width: 1px;
        height: 100vh;
        background: #e6e5e3;
        padding: 15px 25px;
        opacity: 0;
        z-index: -1;
        box-shadow: 2px 0px 3px #c3c1c0;
    }

    #sidebar.visible {
        width: 50%;
        opacity: 1;
        z-index: 1000;
        transition: width 0.15s ease;
    }

    a#closeSidebar {
        float: right;
    }

    a#homeSidebar {
        display: inline-block;
        margin-right: 15px;
        position: absolute;
        bottom: 32px;
    }

    form.frmFrontmatter {
        margin-top: 10px;
    }

    #publishedNotice, #savedNotice {
        display: none;
    }

    button.publish {
        background-color: #18897e;
        margin-top: 15px;
        width: 200px;
        vertical-align: bottom;
        height: 50px;
    }
    button.publish:hover {
        background-color: #15b4a4;
    }

    button.savedraft:disabled, button.savedraft:disabled:hover {
        background-color: #cdcdcd;
        cursor: auto;
    }

    button.savedraft {
        background-color: #2373ad;
    }
    button.savedraft:hover {
        background-color: #3597dd;
    }

    button.unpublish {
        background-color: #b17895;
    }
    button.unpublish:hover {
        background-color: #cd77a4;
    }

</style>