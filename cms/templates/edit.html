{% extends "base.html" %}
{% block body %}
<div id="sidebar">

    <a href="{{ host }}cms/" id="homeSidebar">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" id="home">
            <path fill="none" stroke="#134563" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.65721519,18.7714023 L6.65721519,15.70467 C6.65719744,14.9246392 7.29311743,14.2908272 8.08101266,14.2855921 L10.9670886,14.2855921 C11.7587434,14.2855921 12.4005063,14.9209349 12.4005063,15.70467 L12.4005063,15.70467 L12.4005063,18.7809263 C12.4003226,19.4432001 12.9342557,19.984478 13.603038,20 L15.5270886,20 C17.4451246,20 19,18.4606794 19,16.5618312 L19,16.5618312 L19,7.8378351 C18.9897577,7.09082692 18.6354747,6.38934919 18.0379747,5.93303245 L11.4577215,0.685301154 C10.3049347,-0.228433718 8.66620456,-0.228433718 7.51341772,0.685301154 L0.962025316,5.94255646 C0.362258604,6.39702249 0.00738668938,7.09966612 0,7.84735911 L0,16.5618312 C0,18.4606794 1.55487539,20 3.47291139,20 L5.39696203,20 C6.08235439,20 6.63797468,19.4499381 6.63797468,18.7714023 L6.63797468,18.7714023" transform="translate(2.5 2)"></path></svg>
    </a>    
    <a href="" id="closeSidebar">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="left-arrow" class="small icon">
            <g data-name="Layer 2">
                <g data-name="arrowhead-left" fill="#134563">
                    <path
                        d="M11.64 5.23a1 1 0 0 0-1.41.13l-5 6a1 1 0 0 0 0 1.27l4.83 6a1 1 0 0 0 .78.37 1 1 0 0 0 .78-1.63L7.29 12l4.48-5.37a1 1 0 0 0-.13-1.4z">
                    </path>
                    <path
                        d="m14.29 12 4.48-5.37a1 1 0 0 0-1.54-1.28l-5 6a1 1 0 0 0 0 1.27l4.83 6a1 1 0 0 0 .78.37 1 1 0 0 0 .78-1.63z">
                    </path>
                </g>
            </g>
        </svg>
    </a>
    <form class="frmFrontmatter">
        <input type="text" id="txtTitle" placeholder="Title" value="{{ title }}">
        <input type="text" id="txtDate" placeholder="Date" value="{{ date }}">
        <input type="text" id="txtTags" placeholder="Tags" value="{{ tags }}">
        <input type="text" id="txtImageClass" placeholder="CSS class for main image" value="{{ imageClass }}">
        {% if image == 'true' %}
            <input type="checkbox" id="image" name="image" checked />
        {% else %}
            <input type="checkbox" id="image" name="image" />
        {% endif %}
        <label for="image">For the main image, use image on ImageKit named after the slug</label>
        <button class="publish" id="publish">
            <span id="action">Publish post</span>
            <span id="publishedNotice">PUBLISHED</span>
            <div id="loading"></div>
        </button>
    </form>
</div>
<main>
    <section class="edit col">
        <div class="form">
            <a href="#" id="hamburger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="icon small">
                    <g fill="#134563">
                        <path d="M8.2 13h47.5v6.3H8.2zM8.2 28.8h47.5v6.4H8.2zM8.2 44.7h47.5V51H8.2z"></path>
                    </g>
                </svg>
            </a>
            <textarea id="editBox">{% autoescape off %}{{ md_content }}{% endautoescape %}</textarea>
        </div>
    </section>
    <section class="styledContent col">
        {% autoescape off %}{{ html }}{% endautoescape %}
    </section>
</main>
<script>

    $(document).ready(function () {

        let slug = '{{ slug }}';

        $('#publish').click(function (e) {
            e.preventDefault();
            e.stopPropagation();

            $("#action").hide();
            $("#loading").show();

            const url = (slug === '' ? '/cms/new/create/' : `/cms/${ slug }/save/`);
            var data = {
                content: $("#editBox").val(),
                title: $("#txtTitle").val(),
                date: $("#txtDate").val(),
                tags: $("#txtTags").val(),
                imageClass: $("#txtImageClass").val(),
                image: $("#image").is(":checked"),
                csrfmiddlewaretoken: getCookie('csrftoken'),
            }

            $.ajax({
                url: url,
                type: 'POST',
                data: data,
            }).done(function (response) {
                $("#loading").hide();          
                $("#publishedNotice").show().delay(2000).fadeOut(function(){
                    if(response.status==='created'){
                        window.location.href = `${response.host}cms/edit/${response.slug}/`;
                    }
                });
            })
        })

        $('#editBox').on('keyup', function(){
            var converter = new showdown.Converter(),
            text      = $(this).val(),
            html      = converter.makeHtml(text.replaceAll('/bucket/', '{{ imagekit_bucket }}/'));
            $(".styledContent").html(html);
        })

        $('#hamburger').click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            $("#sidebar").animate({ width: 'toggle' }, 50)
        })

        $('#closeSidebar').click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            $("#sidebar").animate({ width: 'toggle' }, 50)
        })

    })

    // Utility for CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $(document).on('keydown', function(event) {
        if (event.keyCode == 27) {
            if ( $("#sidebar").is(':visible') ){
                $("#sidebar").animate({ width: 'toggle' }, 50)
            }
        }
    });

</script>
{% endblock %}